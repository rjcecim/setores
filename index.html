<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indicadores por Setor</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg-page: #f8f9fa;
      --card-bg: #ffffff;
      --table-header-bg: #e9ecef;
      --shadow-color: rgba(0, 0, 0, 0.075);
      --text-color: #212529;
      --border-color: #dee2e6;

      --color-saldo: #198754;
      --color-porLider: #fd7e14;
      --color-total: #0d6efd;
      --color-text-on-dark: #ffffff;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-page);
      color: var(--text-color);
      font-size: 0.95rem;
    }

    .navbar {
      box-shadow: 0 0.25rem 0.5rem var(--shadow-color);
      margin-bottom: 0;
    }

    .navbar-brand {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.6rem;
    }

    main {
      margin-bottom: 2.5rem;
    }

    #indicadores {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--color-text-on-dark);
      padding: 3rem 0;
    }

    #indicadores header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    #indicadores h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
    }

    #indicadores p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 0;
    }

    .card {
      background-color: var(--card-bg);
      border: none;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1.5rem var(--shadow-color);
      overflow: hidden;
    }

    .table-responsive {
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .table {
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    .table thead th {
      background-color: var(--table-header-bg);
      border-bottom: 2px solid var(--border-color);
      font-weight: 600;
      padding: 1rem 0.75rem;
      white-space: nowrap;
    }

    .table tbody td {
      padding: 0.875rem 0.75rem;
      vertical-align: middle;
      border-bottom: 1px solid var(--border-color);
    }

    .table tbody tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }

    .form-control-sm {
      font-size: 0.85rem;
      padding: 0.375rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #ced4da;
      text-align: center;
    }

    .form-control-sm:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .saldo {
      font-weight: 600;
      color: var(--color-saldo);
    }

    .porLider {
      font-weight: 600;
      color: var(--color-porLider);
    }

    .total {
      font-weight: 700;
      color: var(--color-total);
      font-size: 1rem;
    }

    .pontos {
      /* garante que o conteúdo fique centralizado */
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .pontos .point-circle {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        font-weight: 700;
        font-size: 1rem;
        color: #fff;
        transition: transform 0.2s;
      }

      * Cores conforme faixa de pontos */
      .point-circle.bg-danger   { background: #dc3545; } /* < 1 */
      .point-circle.bg-warning  { background: #ffc107; color: #212529; } /* 1–2 */
      .point-circle.bg-success  { background: #198754; } /* > 2 */

      /* efeito hover/leitura */
      .pontos .point-circle:hover {
        transform: scale(1.1);
      }

    .btn-group {
      margin-top: 1.5rem;
    }

    .btn {
      border-radius: 0.5rem;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #007bff, #6f42c1);
      border: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.15);
    }

    /* Destaque especial para setor SERINGUEIRA */
    .gerencia-row {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
      border-left: 4px solid #ffc107;
    }

    .gerencia-badge {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-bar-chart-line-fill me-2"></i>Indicadores Setoriais</a>
    </div>
  </nav>

  <main>
    <section id="indicadores">
      <div class="container">
        <header>
          <h1><i class="bi bi-graph-up me-3"></i>Dashboard de Indicadores</h1>
          <p>Acompanhe o desempenho dos setores em tempo real</p>
        </header>
        
        <div class="card">
          <div class="btn-group d-flex justify-content-center p-3 border-bottom" role="group">
            <button type="button" class="btn btn-success" id="saveDataBtn">
              <i class="bi bi-download me-2"></i>Salvar Dados
            </button>
            <button type="button" class="btn btn-primary" id="loadDataBtn">
              <i class="bi bi-upload me-2"></i>Carregar Dados
            </button>
            <input type="file" id="loadFileInput" accept=".json" style="display: none;">
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover align-middle text-center mb-0">
              <thead>
                <tr>
                  <th>Código</th>
                  <th class="text-start ps-3">Setor</th>
                  <th><i class="bi bi-play-circle-fill text-success"></i> Inícios</th>
                  <th><i class="bi bi-stop-circle-fill text-danger"></i> Cessadas</th>
                  <th class="text-success-emphasis"><i class="bi bi-calculator-fill"></i> Saldo</th>
                  <th><i class="bi bi-people-fill text-secondary"></i> Líderes</th>
                  <th class="text-warning-emphasis"><i class="bi bi-pie-chart-fill"></i> Média Saldo/Líder</th>
                  <th><i class="bi bi-arrow-repeat text-secondary"></i> Ciclos</th>
                  <th class="text-primary-emphasis"><i class="bi bi-bullseye"></i> Índice Final</th>
                  <th class="text-info-emphasis"><i class="bi bi-trophy-fill"></i> Pontos</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be generated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const setores = [
      {cod:3649,name:'MANDARIM'},{cod:3748,name:'MARACAJÁ'},{cod:3859,name:'TUCUNARÉ'},{cod:3843,name:'CURIÓ'},{cod:3845,name:'ROUXINOL'},{cod:3513,name:'TAMBAQUI'},{cod:3594,name:'BORBOLETAS'},{cod:3714,name:'GUEPARDO'},{cod:3591,name:'BÚFALO'},{cod:3306,name:'BOTO ROSA'},{cod:3642,name:'JAÇANÃ'},{cod:3424,name:'MAPARÁ'},{cod:3598,name:'ARARA'},{cod:3555,name:'CERVO'},{cod:3883,name:'TIGRE'},{cod:3596,name:'ARARACANGA'},{cod:3589,name:'PANTERA'},{cod:3863,name:'GARÇA'},{cod:3844,name:'LEOA'},{cod:249,name:'SERINGUEIRA'}
    ];

    const tbody = document.querySelector('tbody');
    const saveDataBtn = document.getElementById('saveDataBtn');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadFileInput = document.getElementById('loadFileInput');

    // Store row update functions for later use during data load
    const rowUpdaters = new Map();

    setores.forEach(s => {
      const tr = document.createElement('tr');
      tr.dataset.cod = s.cod; // Store cod for easy lookup
      
      // Destacar setor 249 SERINGUEIRA como gerência de vendas
      if (s.cod === 249) {
        tr.classList.add('gerencia-row');
      }
      
      tr.innerHTML = `
        <td>${s.cod}</td>
        <td class="text-start ps-3">
          ${s.name}
          ${s.cod === 249 ? '<span class="badge bg-warning text-dark ms-2 gerencia-badge"><i class="bi bi-star-fill"></i> GERÊNCIA DE VENDAS</span>' : ''}
        </td>
        <td><input type="number" min="0" class="form-control form-control-sm inicios" placeholder="0" value="0"></td>
        <td><input type="number" min="0" class="form-control form-control-sm cessadas" placeholder="0" value="0"></td>
        <td class="saldo">0</td>
        <td><input type="number" min="0" value="0" class="form-control form-control-sm lideres"></td>
        <td class="porLider">0.00</td>
        <td><input type="number" min="0" value="0" class="form-control form-control-sm ciclos"></td>
        <td class="total">0.00</td>
        <td class="pontos"><span class="badge bg-secondary">0</span></td>
      `;
      tbody.append(tr);

      const iniciosInput = tr.querySelector('.inicios');
      const cessadasInput = tr.querySelector('.cessadas');
      const lideresInput = tr.querySelector('.lideres');
      const ciclosInput = tr.querySelector('.ciclos');
      const saldoCell = tr.querySelector('.saldo');
      const plCell = tr.querySelector('.porLider');
      const totCell = tr.querySelector('.total');
      const pontosCell = tr.querySelector('.pontos');

      function atualizarLinhaEAnimar() {
        const i = +iniciosInput.value || 0;
        const c = +cessadasInput.value || 0;
        const l = +lideresInput.value || 0;
        const k = +ciclosInput.value || 0;

        const saldo = i - c;
        const porL = l > 0 ? saldo / l : 0;
        const total = k > 0 ? porL / k : 0;

        // Sistema de pontuação baseado no Índice Final
        let pontos = 0;
        let badgeClass = 'bg-secondary';
        let badgeIcon = '';
        
        if (total < 0) {
          pontos = 0;
          badgeClass = 'bg-danger';
          badgeIcon = '<i class="bi bi-x-circle-fill me-1"></i>';
        } else if (total >= 0 && total <= 2) {
          pontos = 1;
          badgeClass = 'bg-warning text-dark';
          badgeIcon = '<i class="bi bi-dash-circle-fill me-1"></i>';
        } else if (total > 2) {
          pontos = 2;
          badgeClass = 'bg-success';
          badgeIcon = '<i class="bi bi-check-circle-fill me-1"></i>';
        }

        saldoCell.textContent = saldo;
        plCell.textContent = porL.toFixed(2);
        totCell.textContent = total.toFixed(2);
        pontosCell.innerHTML = `
        <span class="point-circle ${badgeClass.replace(/bg-/, 'bg-')}">
          ${pontos}
        </span>
      `;

        const cellsToAnimate = [saldoCell, plCell, totCell, pontosCell];
        if (document.hidden) return; // Don't animate if tab is not visible

        gsap.fromTo(cellsToAnimate,
          { scale: 1.1, opacity: 0.8 },
          {
            duration: 0.35,
            scale: 1,
            opacity: 1,
            stagger: 0.07,
            ease: "back.out(1.7)"
          }
        );
      }
      rowUpdaters.set(s.cod.toString(), atualizarLinhaEAnimar); // Store updater by cod

      [iniciosInput, cessadasInput, lideresInput, ciclosInput].forEach(el => {
        el.addEventListener('input', atualizarLinhaEAnimar);
      });
      atualizarLinhaEAnimar(); // Initial calculation
    });

    // --- Save Data Functionality ---
    saveDataBtn.addEventListener('click', () => {
      const dataToSave = [];
      document.querySelectorAll('tbody tr').forEach(tr => {
        const cod = tr.dataset.cod;
        const inicios = tr.querySelector('.inicios').value;
        const cessadas = tr.querySelector('.cessadas').value;
        const lideres = tr.querySelector('.lideres').value;
        const ciclos = tr.querySelector('.ciclos').value;
        const pontos = tr.querySelector('.pontos .badge').textContent.replace(/[^0-9]/g, ''); // Extract only number
        dataToSave.push({ cod, inicios, cessadas, lideres, ciclos, pontos });
      });

      const jsonData = JSON.stringify(dataToSave, null, 2); // Pretty print JSON
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'indicadores_data.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      console.log('Data saved.');
    });

    // --- Load Data Functionality ---
    loadDataBtn.addEventListener('click', () => {
      loadFileInput.click(); // Trigger hidden file input
    });

    loadFileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const loadedData = JSON.parse(e.target.result);
          if (!Array.isArray(loadedData)) {
            throw new Error("Formato de dados inválido. Esperado um array.");
          }

          loadedData.forEach(item => {
            const tr = tbody.querySelector(`tr[data-cod="${item.cod}"]`);
            if (tr) {
              tr.querySelector('.inicios').value = item.inicios || 0;
              tr.querySelector('.cessadas').value = item.cessadas || 0;
              tr.querySelector('.lideres').value = item.lideres || 0;
              tr.querySelector('.ciclos').value = item.ciclos || 0;

              // Call the specific updater for this row
              const updater = rowUpdaters.get(item.cod.toString());
              if (updater) {
                updater();
              }
            } else {
              console.warn(`Setor com código ${item.cod} não encontrado na tabela.`);
            }
          });
          console.log('Data loaded successfully.');
        } catch (error) {
          console.error('Erro ao carregar ou processar o arquivo JSON:', error);
          alert(`Erro ao carregar dados: ${error.message}`);
        } finally {
          // Reset file input to allow loading the same file again
          event.target.value = null;
        }
      };
      reader.onerror = () => {
        console.error('Erro ao ler o arquivo.');
        alert('Erro ao ler o arquivo.');
        event.target.value = null;
      };
      reader.readAsText(file);
    });

    // GSAP initial animations
    gsap.from('.navbar', { duration: 0.5, y: -50, opacity: 0, ease: "power2.out" });
    gsap.from('#indicadores header', { duration: 0.6, y: -30, opacity: 0, delay: 0.2, ease: "power2.out" });
    gsap.from('#indicadores .card', { duration: 0.7, scale: 0.98, opacity: 0, delay: 0.3, ease: "back.out(1.2)" });
    gsap.from('tbody tr', { duration: 0.4, opacity: 0, y: 15, stagger: 0.03, delay: 0.6, ease: "power2.out" });

  </script>
</body>
</html>